<!DOCTYPE html>
<html>
  <head>
    <title>Counsellor Login</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
  </head>
  <body>
    <h2>Login with Gmail</h2>
    <div id="g_id_onload"
         data-client_id="887130931128-mevrb3v6ros4t6elaivotb4ggaksodig.apps.googleusercontent.com"
         data-context="signin"
         data-ux_mode="popup"
         data-callback="handleCredentialResponse"
         data-auto_prompt="false">
    </div>
    <div class="g_id_signin"
         data-type="standard"
         data-shape="pill"
         data-theme="outline"
         data-text="signin_with"
         data-size="large">
    </div>

    <div id="dashboard" style="display:none;">
      <h2>Import Clients CSV</h2>
      <input type="file" id="csvFile" accept=".csv" />
      <button onclick="uploadCSV()">Upload</button>
      <div id="status"></div>
    </div>

    <script>
      let idToken = "";

      async function handleCredentialResponse(response) {
        idToken = response.credential;

        // Show dashboard after login
        document.getElementById("dashboard").style.display = "block";

        // Optionally fetch clients immediately
        const res = await fetch("https://script.google.com/macros/s/AKfycbxCYB1bTxmT84dXLeEltz8S9BINaWAk18n5RRV6QflnzvxopU_Qro9KjWQkJDBtKum8/exec", {
          method: "POST",
          mode: "cors", // ✅ ensure proper CORS handling
          headers: {
            "Authorization": "Bearer " + idToken,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ action: "getClients" })
        });

        const data = await res.json();
        if (data.status === "ok") {
          document.open();
          document.write(data.html);
          document.close();
        }
      }

      async function uploadCSV() {
        const file = document.getElementById("csvFile").files[0];
        if (!file) {
          alert("Please select a CSV file first.");
          return;
        }

        document.getElementById("status").innerHTML = "⏳ Upload in progress...";

        const reader = new FileReader();
        reader.onload = async function(e) {
          try {
            const res = await fetch("https://script.google.com/macros/s/AKfycbyFhSnC7m9Bp5VeK8LmYs4tOkWHt5_wqcqn9ICuBDoE2Y4csve-kkg1T81vLAuLfAVu/exec", {
              method: "POST",
              mode: "cors", // ✅ ensure proper CORS handling
              headers: {
                "Authorization": "Bearer " + idToken,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({ action: "importCSV", csvString: e.target.result })
            });

            const data = await res.json();
            if (data.status === "ok") {
              document.getElementById("status").innerHTML = data.message;
              // Reload clients tab
              handleCredentialResponse({ credential: idToken });
            } else {
              document.getElementById("status").innerHTML = "❌ Upload failed: " + (data.error || "Unknown error");
            }
          } catch (err) {
            document.getElementById("status").innerHTML = "⚠️ Error: " + err.message;
          }
        };
        reader.readAsText(file);
      }
    </script>
  </body>
</html>
